-- SQL Advanced Data Analytics Project 
-- Tasks included in the project : Database setup
--                                 Change over time analysis
--                                 Cumulative Analysis
--                                 Performance Analysis
--                                 Part to whole (Proportional Analysis)
--                                 Data SEgementation
--                                 Reporting

-- First of all , we have to create schema and Tables in our database 

-- Create schema 
CREATE SCHEMA gold;

-- Create the tables 
CREATE TABLE gold.dim_customers(
	customer_key int,
	customer_id int,
	customer_number varchar(50),
	first_name varchar(50),
	last_name varchar(50),
	country varchar(50),
	marital_status varchar(50),
	gender varchar(50),
	birthdate date,
	create_date date
);

CREATE TABLE gold.dim_products(
	product_key int ,
	product_id int ,
	product_number varchar(50) ,
	product_name varchar(50) ,
	category_id varchar(50) ,
	category varchar(50) ,
	subcategory varchar(50) ,
	maintenance varchar(50) ,
	cost int,
	product_line varchar(50),
	start_date date 
);

CREATE TABLE gold.fact_sales(
	order_number varchar(50),
	product_key int,
	customer_key int,
	order_date date,
	shipping_date date,
	due_date date,
	sales_amount int,
	quantity smallint,
	price int 
);

-- Now , import data in all of the created tables 
-- You can import data by using the import command or by writing the code 

\copy gold.dim_customers
FROM 'C:\Users\TALAL BIN ZAHID\Downloads\gold.dim_customers.csv'
DELIMITER ','
CSV HEADER
NULL '';

\copy gold.dim_products
FROM 'C:\Users\TALAL BIN ZAHID\Downloads\gold.dim_products.csv'
DELIMITER ','
CSV HEADER
NULL '';

\copy gold.fact_sales
FROM 'C:\Users\TALAL BIN ZAHID\Downloads\gold.fact_sales.csv'
DELIMITER ','
CSV HEADER
NULL '';

-- Now , the data is imported so we would start the analysis

-- Change over Time analysis 
-- Purpose:
--    - To track trends, growth, and changes in key metrics over time.
--    - For time-series analysis and identifying seasonality.
--    - To measure growth or decline over specific periods.

-- SQL Functions Used:
--    - Date Functions: DATEPART(), DATETRUNC(), FORMAT()
--    - Aggregate Functions: SUM(), COUNT(), AVG()

-- Sales performance over time 
select order_date , sales_amount from gold.fact_sales
where order_date is not null
order by order_date ;

-- sum of total sales in a day 
select order_date , SUM(sales_amount) from gold.fact_sales
where order_date is not null
group by order_date
order by order_date ;

-- total sales , customers and quantity in a month
SELECT EXTRACT(Month FROM order_date) AS order_month, SUM(sales_amount) AS total_sales ,
Count (Distinct customer_key ) , SUM(quantity) as total_quantity FROM gold.fact_sales
WHERE order_date IS NOT NULL
GROUP BY order_month
ORDER BY order_month;

-- total sales , customers and quantity in a year 
SELECT EXTRACT(YEAR FROM order_date) AS order_year,
EXTRACT(Month FROM order_date) AS order_month ,
SUM(sales_amount) AS total_sales ,
Count (Distinct customer_key ) ,
SUM(quantity) as total_quantity FROM gold.fact_sales
WHERE order_date IS NOT NULL
GROUP BY order_year , order_month
ORDER BY order_year , order_month ;

-- Date_trunc
SELECT  DATE_TRUNC('month', order_date) AS order_month,
SUM(sales_amount) AS total_sales,
COUNT(DISTINCT customer_key) AS total_customers,
SUM(quantity) AS total_quantity
FROM gold.fact_sales
WHERE order_date IS NOT NULL
GROUP BY order_month
ORDER BY order_month;

-- Format 
SELECT  TO_CHAR(order_date, 'YYYY-Mon') AS order_month,
SUM(sales_amount) AS total_sales,
COUNT(DISTINCT customer_key) AS total_customers,
SUM(quantity) AS total_quantity

-- Cumulative Analysis 
-- Purpose:
--    - To calculate running totals or moving averages for key metrics.
--    - To track performance over time cumulatively.
--    - Useful for growth analysis or identifying long-term trends.

-- SQL Functions Used:
--    - Window Functions: SUM() OVER(), AVG() OVER()

-- Calculate the total sales per month 
-- The cummulative total of sales over time

Select DATE_TRUNC('month', order_date) AS order_month,
SUM(sales_amount) as total_sales 
from gold.fact_sales
where order_date is not null
group by order_month
order by order_month;

-- Cummulative Total Sales 
select order_month , total_sales ,
SUM (total_sales) over (order by order_month) as cummulative_total_sales
from
(
Select DATE_TRUNC('month', order_date) AS order_month,
SUM(sales_amount) as total_sales 
from gold.fact_sales
where order_date is not null
group by order_month
) ;

-- Cummulative Total Sales for each year
select order_month , total_sales ,
SUM (total_sales) over ( Partition by order_month order by order_month) as cummulative_total_sales
from
(
Select DATE_TRUNC('month', order_date) AS order_month,
SUM(sales_amount) as total_sales 
from gold.fact_sales
where order_date is not null
group by order_month
) ;
FROM gold.fact_sales
WHERE order_date IS NOT NULL
GROUP BY TO_CHAR(order_date, 'YYYY-Mon')
ORDER BY TO_CHAR(order_date, 'YYYY-Mon');

-- Moving average of the price
select order_month , total_sales ,
SUM (total_sales) over (order by order_month) as cummulative_total_sales ,
Round(AVG(avg_price) over (order by order_month),0) as moving_average_price
from
(
Select DATE_TRUNC('month', order_date) AS order_month,
SUM(sales_amount) as total_sales ,
AVG (price) as avg_price
from gold.fact_sales
where order_date is not null
group by order_month
) ;
